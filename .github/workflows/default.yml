name: ATA Senior Project CI/CD Pipeline

on:
  push:
    branches: [main, deployment]
  pull_request:
    branches: [main, deployment]

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'
  BUN_VERSION: '1.2.2'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Setup and dependency validation
  setup:
    runs-on: ubuntu-latest
    outputs:
      java-version: ${{ steps.java-version.outputs.version }}
      node-version: ${{ steps.node-version.outputs.version }}
      bun-version: ${{ steps.bun-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up Bun ${{ env.BUN_VERSION }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Bun packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            **/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/package.json', '**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Get Java version
        id: java-version
        run: echo "version=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2)" >> $GITHUB_OUTPUT

      - name: Get Node.js version
        id: node-version
        run: echo "version=$(node --version)" >> $GITHUB_OUTPUT

      - name: Get Bun version
        id: bun-version
        run: echo "version=$(bun --version)" >> $GITHUB_OUTPUT

      - name: Install script dependencies (if scripts directory exists)
        run: |
          if [ -d "scripts" ]; then
            cd scripts
            bun install
          else
            echo "‚ÑπÔ∏è  No scripts directory found, skipping script dependencies"
          fi

      - name: Start essential services
        run: |
          docker compose up -d postgres redis
          sleep 15

      - name: Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          until docker exec ata-it-postgres pg_isready -U postgres; do 
            echo "PostgreSQL not ready, waiting..."
            sleep 3
          done
          echo "‚úÖ PostgreSQL is ready."
          
          echo "Waiting for Redis..."
          until docker exec ata-it-redis redis-cli ping | grep PONG; do 
            echo "Redis not ready, waiting..."
            sleep 3
          done
          echo "‚úÖ Redis is ready."

  # Backend Spring Boot WebFlux
  backend:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Validate Spring Boot and WebFlux versions
        run: |
          cd backend/main
          echo "üîç Checking Spring Boot and WebFlux dependencies..."
          ./gradlew dependencies --configuration compileClasspath | grep -E "(spring-boot-starter-webflux|spring-boot-starter)" || true
          echo "‚úÖ Dependency check completed"

      - name: Clean and build Backend
        run: |
          cd backend/main
          ./gradlew clean build --no-daemon --info --stacktrace

      - name: Run Backend tests
        run: |
          cd backend/main
          ./gradlew test --no-daemon --info --stacktrace

      - name: Check WebFlux configuration
        run: |
          cd backend/main
          echo "üîç Verifying WebFlux configuration..."
          if grep -q "spring-boot-starter-webflux" build.gradle; then
            echo "‚úÖ WebFlux dependency found"
          else
            echo "‚ùå WebFlux dependency not found"
            exit 1
          fi

  # Admin Frontend
  admin-frontend:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Bun ${{ env.BUN_VERSION }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            frontend/admin/node_modules
          key: ${{ runner.os }}-bun-admin-${{ hashFiles('frontend/admin/package.json', 'frontend/admin/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-admin-

      - name: Install Admin Frontend dependencies
        run: |
          cd frontend/admin
          bun install --frozen-lockfile

      - name: Lint Admin Frontend
        run: |
          cd frontend/admin
          bun run lint || echo "Linting completed with warnings"

      - name: Build Admin Frontend
        run: |
          cd frontend/admin
          echo "Building Admin Frontend..."
          timeout 300 bun run build || (echo "Build failed with timeout or error, trying with --no-lint" && timeout 300 bun run build --no-lint)

      - name: Test Admin Frontend (if test script exists)
        run: |
          cd frontend/admin
          if bun run --silent test 2>/dev/null; then
            echo "‚úÖ Admin Frontend tests passed"
          else
            echo "‚ÑπÔ∏è  No test script found for Admin Frontend"
          fi

  # Employee Frontend
  employee-frontend:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Bun ${{ env.BUN_VERSION }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            frontend/employee/node_modules
          key: ${{ runner.os }}-bun-employee-${{ hashFiles('frontend/employee/package.json', 'frontend/employee/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-employee-

      - name: Install Employee Frontend dependencies
        run: |
          cd frontend/employee
          bun install --frozen-lockfile

      - name: Lint Employee Frontend
        run: |
          cd frontend/employee
          bun run lint || echo "Linting completed with warnings"

      - name: Build Employee Frontend
        run: |
          cd frontend/employee
          echo "Building Employee Frontend..."
          timeout 300 bun run build || (echo "Build failed with timeout or error, trying with --no-lint" && timeout 300 bun run build --no-lint)

      - name: Test Employee Frontend (if test script exists)
        run: |
          cd frontend/employee
          if bun run --silent test 2>/dev/null; then
            echo "‚úÖ Employee Frontend tests passed"
          else
            echo "‚ÑπÔ∏è  No test script found for Employee Frontend"
          fi

  # Docker build and test
  docker:
    runs-on: ubuntu-latest
    needs: [backend, admin-frontend, employee-frontend]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          echo "Building Docker images..."
          docker compose build --no-cache --parallel

      - name: Test Docker services
        run: |
          docker compose up -d
          sleep 45
          
          # Test backend health with retry
          echo "Testing backend health..."
          for i in {1..5}; do
            if curl -f http://localhost:8080/actuator/health; then
              echo "‚úÖ Backend health check passed"
              break
            else
              echo "Backend not ready, attempt $i/5..."
              sleep 10
            fi
          done
          
          # Test frontend services with retry
          echo "Testing Admin Frontend..."
          for i in {1..5}; do
            if curl -f http://localhost:3000; then
              echo "‚úÖ Admin Frontend is accessible"
              break
            else
              echo "Admin Frontend not ready, attempt $i/5..."
              sleep 10
            fi
          done
          
          echo "Testing Employee Frontend..."
          for i in {1..5}; do
            if curl -f http://localhost:3001; then
              echo "‚úÖ Employee Frontend is accessible"
              break
            else
              echo "Employee Frontend not ready, attempt $i/5..."
              sleep 10
            fi
          done

      - name: Show service status
        run: |
          echo "üìä Docker Compose Services Status:"
          docker compose ps
          
          echo "üê≥ Docker Images:"
          docker images | grep -E "(ata-it|postgres|redis)" || echo "No matching images found"
          
          echo "üìã Service Logs (last 50 lines):"
          docker compose logs --tail=50

  # Deploy to staging (only on deployment branch)
  deploy-staging:
    runs-on: self-hosted
    needs: [docker]
    if: github.ref == 'refs/heads/deployment'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull latest code
        run: git pull origin deployment

      - name: Stop existing services
        run: |
          docker compose down || true

      - name: Deploy all services
        run: |
          docker compose up -d --build

      - name: Verify deployment
        run: |
          sleep 45
          docker compose ps
          
          # Verify backend with retry
          echo "Verifying backend deployment..."
          for i in {1..5}; do
            if curl -f http://localhost:8080/actuator/health; then
              echo "‚úÖ Backend deployment verified"
              break
            else
              echo "Backend not ready, attempt $i/5..."
              sleep 15
            fi
          done
          
          # Verify frontend services with retry
          echo "Verifying Admin Frontend deployment..."
          for i in {1..5}; do
            if curl -f http://localhost:3000; then
              echo "‚úÖ Admin Frontend deployment verified"
              break
            else
              echo "Admin Frontend not ready, attempt $i/5..."
              sleep 15
            fi
          done
          
          echo "Verifying Employee Frontend deployment..."
          for i in {1..5}; do
            if curl -f http://localhost:3001; then
              echo "‚úÖ Employee Frontend deployment verified"
              break
            else
              echo "Employee Frontend not ready, attempt $i/5..."
              sleep 15
            fi
          done